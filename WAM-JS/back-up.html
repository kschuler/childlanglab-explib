<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Whack-a-mole!</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
   <!-- libraries required for YAML parsing -->
  <script src="../js/yaml.js" type="text/javascript"></script>
   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
    
<div class="outer">
    <div id="start"></div>
    <!-- Holes will be added here    -->
</div>
    
<div class="start-screen">
<div class="splash-screen">
  <div class="button">
    <button>Start</button>
    <div class="show-score"></div>
  </div>
   <div class = "timer hide">You did a great job!  Game will restart in <span id="time">04:00</span> minutes!</div>
</div>
</div>
    
<!--
<div class="outer">
      <div class="inner">Your Test </div>
</div>
-->

  <div class="score-block">
    <span class="score">0</span>
  </div>

  <audio src="sounds/bonk.WAV"></audio>
  <script src="js/app.js"></script>
    
  <script> 
    var PARAMS = YAML.load('params.yaml');

    const scoreBoard = document.querySelector('.score');
    const moles = document.querySelectorAll('.mole');
    const btnStart = document.querySelector('button');
    const bonkSound = document.querySelector('audio');
    const startScreen = document.querySelector('.start-screen');
    const showScore = document.querySelector('.show-score');
    const timer = document.querySelector('.timer');

      
    let score = 0;
    let lastHole;
    let Rest = PARAMS.setup.time;
    let popSequence = PARAMS.setup.sequence;
    let unitLenth = PARAMS.setup.unitLenth;
    let maxRepeat = PARAMS.setup.maxRepeat;
    let repeatCount = 0;
    let Positions = PARAMS.setup.positions;
    let holeNum = PARAMS.setup.holeNum; 
    let peepMin = PARAMS.setup.peepMinTime;  
    let peepMax = PARAMS.setup.peepMaxTime;  
      
    /* load the paramter file as object and save in variable */
    console.log(popSequence);

      
    //var timeline = [];
    function generateHoles() {
      var AllHoles = [];// the html that denotes holes.
      // var Positions = [20,500,20,1000,220,500,220,1000];     
      for (var i = 1; i <= holeNum/* 4 */; i++) {
          var holei = "<div style=\"top:"+Positions[i*2-2]+"px;left:"+Positions[i*2-1]+"px;\" class=\"hole hole"+i+"\"><div class=\"mole\"></div> </div>";
          AllHoles.push(holei);
      }
      $("#start").after(AllHoles); 
      // Insert HTML elements after #start

    }
    generateHoles(); 
    const holes = document.querySelectorAll('.hole');
      
    function randomTime(min, max) {
      return Math.round( Math.random() * (max - min) + min );
    }

    function selectPopHole(holes, i) {
      const idx = popSequence[i];
      const hole = holes[idx];
      return hole;
    }
      
    let i = 0;
    function peep() {
      const popTime = randomTime(2000, 2000);
      console.log('Peep!');

      // Reset i when reach the end of holes
      if ( i >= holeNum ) { 
          console.log('Reset i = 0!');
          i = 0; 
      }
      
      const hole = selectPopHole(holes, i++);
      console.log("hole = " + hole);  
      
      // When go through a sequence, increment the repeat counter.
      if (i == popSequence.length) {
        repeatCount++;
        console.log('repeatCount = ' + repeatCount);  
      }   
      
      hole.classList.add('up');
      // finish a peep in each unit game
      setTimeout(() => {
        hole.classList.remove('up');
        scoreBoard.classList.remove('add');
        if (repeatCount != maxRepeat) { peep();}
        else {
            
            Rest = true;
            console.log('Rest  =' + Rest);
            timer.classList.remove('hide');
            startScreen.classList.remove('hide');
            btnStart.classList.add('hide');
            showScore.classList.add('show');
            const message = 'Your score: ' + score + (score >= 10 ? " GREAT!" : '');
            showScore.textContent = message;
        }  
      }, popTime);
    }//end peep

    function Start() {
        
      console.log('Start a new block!');
      score = 0;
      scoreBoard.textContent = score;
      Rest = false;
      scoreBoard.classList.remove('add');
      startScreen.classList.add('hide');
      
      peep(); 
        
      // show the start button.    
      setTimeout(() => {
          btnStart.classList.remove('hide');
      }, 20000);

    }
      
      
    function bonk(e) {
      bonkSound.currentTime = 0;
      console.log("bonk!");
      //if (!Rest) {
        bonkSound.play();
        scoreBoard.classList.add('add');
        score++;
        scoreBoard.textContent = score;
      //}
    }


    moles.forEach( mole => {
      mole.addEventListener('click', bonk);
    } );

    btnStart.addEventListener('click', Start);

    function startTimer(duration, display) {
        var timer = duration, minutes, seconds;

        setInterval(function () {
            
            minutes = parseInt(timer / 60, 10)
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                timer = duration;
            }
        }, 1000);
    }

    window.onload = function () {
        var Minutes = 60 * 4,
            display = document.querySelector('#time');
        startTimer(Minutes, display);
    };
     
  </script>>
</body>
</html>
